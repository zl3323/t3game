<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T3 Battle - Fighting Arena</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=VT323&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-red: #ff0044;
      --primary-blue: #0088ff;
      --primary-yellow: #ffcc00;
      --dark-bg: #0a0e27;
      --light-bg: #1a1e37;
      --gold: #ffcc00;
      --success: #00ff88;
      --danger: #ff3366;
      --text-light: #ffffff;
      --text-dim: #8899aa;
      --ghost-hp: rgba(255, 255, 255, 0.3);
    }

    body {
      font-family: 'VT323', monospace;
      background: #000;
      min-height: 100vh;
      color: var(--text-light);
      overflow-x: hidden;
      position: relative;
    }

    /* Cover Screen */
    .cover-screen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity .5s ease-out, visibility .5s ease-out;
    }

    .cover-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .cover-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      filter: brightness(.9);
    }

    .cover-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, .3) 50%, rgba(0, 0, 0, .7) 100%);
    }

    .cover-content {
      position: relative;
      z-index: 10;
      text-align: center;
      animation: coverFloat 3s ease-in-out infinite;
    }

    @keyframes coverFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .game-logo {
      font-family: 'Press Start 2P', cursive;
      font-size: 72px;
      margin-bottom: 20px;
      text-shadow:
        3px 3px 0 #000,
        -3px -3px 0 #000,
        3px -3px 0 #000,
        -3px 3px 0 #000,
        0 0 20px var(--primary-yellow),
        0 0 40px var(--primary-yellow);
      letter-spacing: 4px;
      animation: logoGlow 2s ease-in-out infinite;
    }

    .game-logo .t3 {
      color: var(--primary-yellow);
      display: inline-block;
      animation: t3Pulse 1s ease-in-out infinite;
    }

    .game-logo .battle {
      color: var(--text-light);
      display: inline-block;
    }

    @keyframes logoGlow {

      0%,
      100% {
        filter: brightness(1);
      }

      50% {
        filter: brightness(1.2);
      }
    }

    @keyframes t3Pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .start-button {
      margin-top: 50px;
      padding: 20px 60px;
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-yellow), var(--primary-red));
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
      box-shadow: 0 10px 30px rgba(255, 204, 0, .3), 0 0 0 3px rgba(255, 255, 255, .1);
      animation: startBtnPulse 2s ease-in-out infinite;
    }

    @keyframes startBtnPulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 10px 30px rgba(255, 204, 0, .3), 0 0 0 3px rgba(255, 255, 255, .1);
      }

      50% {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(255, 204, 0, .5), 0 0 0 5px rgba(255, 255, 255, .2);
      }
    }

    .start-button:hover {
      transform: translateY(-3px) scale(1.1);
      box-shadow: 0 20px 50px rgba(255, 204, 0, .6), 0 0 0 5px rgba(255, 255, 255, .3);
    }

    .press-start-text {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Press Start 2P', cursive;
      font-size: 20px;
      color: rgba(255, 255, 255, .8);
      animation: blink 1s step-start infinite;
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      50.01%,
      100% {
        opacity: 0;
      }
    }

    /* Main Game Container */
    .game-container {
      display: none;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1e37 50%, #0a0e27 100%);
      position: relative;
    }

    .game-container.active {
      display: block;
    }

    .game-container::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px);
      pointer-events: none;
      z-index: 1;
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    html,
    body {
      height: 100%;
    }

    body {
      overflow: hidden;
      /* Èò≤Ê≠¢È°µÈù¢Êï¥‰Ωì‰π±Êªö */
    }

    /* ÂÖ≥ÈîÆÔºöÁî® 100dvh ÈÄÇÈÖçÁßªÂä®Á´ØÂä®ÊÄÅÂú∞ÂùÄÊ†è */
    .game-container {
      height: 100dvh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* HUD Âª∫ËÆÆ stickyÔºåÈÅøÂÖçÈ°∂ÈÉ®Âç†Êª°ÂèàÁúã‰∏çÂà∞È¢ò */
    .battle-hud {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    /* Header */
    .game-header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 30px;
      background: linear-gradient(135deg, rgba(255, 204, 0, .1), rgba(255, 0, 68, .1));
      border-radius: 20px;
      border: 2px solid rgba(255, 255, 255, .1);
    }

    .game-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 42px;
      background: linear-gradient(45deg, var(--primary-yellow), var(--primary-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(255, 204, 0, .3);
      margin-bottom: 10px;
    }

    .game-subtitle {
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      color: var(--text-dim);
      letter-spacing: 4px;
    }

    /* Screens */
    .screen {
      display: none;
      animation: screenFadeIn .5s ease-out;
    }

    .screen.active {
      display: block;
    }

    @keyframes screenFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mode Screen */
    .mode-screen {
      text-align: center;
      padding: 60px 20px;
    }

    .mode-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 36px;
      color: var(--gold);
      margin-bottom: 60px;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
      animation: titleFloat 2s ease-in-out infinite;
    }

    @keyframes titleFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }

    .mode-buttons {
      display: flex;
      justify-content: center;
      gap: 60px;
      flex-wrap: wrap;
    }

    .mode-button {
      background: linear-gradient(135deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 30px;
      padding: 40px 60px;
      cursor: pointer;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .mode-button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 204, 0, .2) 0%, transparent 70%);
      opacity: 0;
      transition: opacity .3s;
    }

    .mode-button:hover {
      transform: translateY(-10px) scale(1.05);
      border-color: var(--gold);
      box-shadow: 0 20px 40px rgba(255, 204, 0, .4);
    }

    .mode-button:hover::before {
      opacity: 1;
    }

    .mode-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .mode-name {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 10px;
    }

    .mode-desc {
      font-size: 20px;
      color: var(--text-dim);
    }

    /* Character Selection */
    .character-selection-container {
      margin-top: 40px;
    }

    .selection-title {
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      font-size: 32px;
      color: var(--gold);
      margin-bottom: 40px;
      animation: titleFloat 2s ease-in-out infinite;
    }

    .player-turn-indicator {
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      font-size: 28px;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 204, 0, .2), rgba(255, 0, 68, .2));
      border-radius: 20px;
      border: 2px solid var(--gold);
    }

    .player-turn-indicator.player1 {
      color: var(--primary-yellow);
      text-shadow: 0 0 20px rgba(255, 204, 0, .5);
    }

    .player-turn-indicator.player2 {
      color: var(--primary-blue);
      text-shadow: 0 0 20px rgba(0, 136, 255, .5);
    }

    .character-showcase {
      background: linear-gradient(135deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
      border-radius: 30px;
      padding: 40px;
      border: 2px solid rgba(255, 204, 0, .3);
      box-shadow: 0 0 50px rgba(255, 204, 0, .1);
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .character-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
      border: 2px solid rgba(255, 255, 255, .2);
      border-radius: 20px;
      padding: 20px;
      cursor: pointer;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .character-card.disabled {
      opacity: .3;
      cursor: not-allowed;
      transform: scale(.95);
    }

    .character-card.selected {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(0, 255, 136, .2), rgba(0, 255, 136, .1));
      box-shadow: 0 0 30px rgba(0, 255, 136, .5), inset 0 0 20px rgba(0, 255, 136, .2);
      animation: selectedPulse 1s ease-in-out infinite;
    }

    @keyframes selectedPulse {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(0, 255, 136, .5), inset 0 0 20px rgba(0, 255, 136, .2);
      }

      50% {
        box-shadow: 0 0 50px rgba(0, 255, 136, .7), inset 0 0 30px rgba(0, 255, 136, .3);
      }
    }

    .character-avatar {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      background: rgba(255, 255, 255, .05);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      image-rendering: pixelated;
    }

    .character-avatar img {
      width: 90%;
      height: 90%;
      object-fit: contain;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, .3));
      transition: transform .3s ease;
    }

    .character-card:hover:not(.disabled) .character-avatar img {
      transform: scale(1.1);
    }

    .character-name {
      font-family: 'Press Start 2P', cursive;
      font-size: 16px;
      text-align: center;
      margin-bottom: 15px;
      color: var(--gold);
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
    }

    .character-stats {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-name {
      font-size: 18px;
      color: var(--text-dim);
      font-weight: bold;
    }

    .stat-bar {
      width: 80px;
      height: 10px;
      background: rgba(255, 255, 255, .1);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .2);
    }

    .stat-fill {
      height: 100%;
      border-radius: 5px;
    }

    .stat-fill.health {
      background: linear-gradient(90deg, #00ff88, #00cc66);
    }

    .stat-fill.attack {
      background: linear-gradient(90deg, #ff3366, #ff0044);
    }

    .stat-fill.defense {
      background: linear-gradient(90deg, #0088ff, #0066cc);
    }

    /* Battle HUD */
    .battle-hud {
      background: linear-gradient(135deg, rgba(0, 0, 0, .8), rgba(0, 0, 0, .6));
      border-bottom: 3px solid rgba(255, 204, 0, .3);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      backdrop-filter: blur(10px);
    }

    .hud-player {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .hud-player.p2 {
      flex-direction: row-reverse;
    }

    .hud-avatar {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .1);
      border: 2px solid var(--gold);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hud-avatar img {
      width: 90%;
      height: 90%;
      object-fit: contain;
      image-rendering: pixelated;
    }

    .hud-info {
      flex: 1;
    }

    .hud-info.p2 {
      text-align: right;
    }

    .hud-name {
      font-family: 'Press Start 2P', cursive;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .hud-player.p1 .hud-name {
      color: var(--primary-yellow);
    }

    .hud-player.p2 .hud-name {
      color: var(--primary-blue);
    }

    .hud-hp-bar {
      width: 200px;
      height: 20px;
      background: rgba(0, 0, 0, .5);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 2px solid rgba(255, 255, 255, .2);
    }

    .hud-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc66);
      transition: width .3s cubic-bezier(.4, 0, .2, 1);
      position: relative;
      z-index: 2;
    }

    .hud-hp-ghost {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--ghost-hp);
      transition: width 1s ease-out;
      transition-delay: .2s;
      z-index: 1;
    }

    .hud-hp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'VT323', monospace;
      font-size: 16px;
      color: #fff;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, .7);
      z-index: 3;
    }

    .hud-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .round-indicator {
      font-family: 'Press Start 2P', cursive;
      font-size: 20px;
      color: var(--gold);
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
      margin-bottom: 5px;
    }

    .hud-timer {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      color: #fff;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
    }

    .hud-timer.warning {
      color: var(--danger);
      animation: timerPulse .5s ease-in-out infinite;
    }

    @keyframes timerPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    /* Arena */
    .battle-arena {
      background: linear-gradient(135deg, rgba(255, 0, 68, .1), rgba(0, 136, 255, .1), rgba(255, 204, 0, .1));
      border: 3px solid rgba(255, 255, 255, .2);
      border-radius: 30px;
      padding: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 50px rgba(255, 204, 0, .2), inset 0 0 50px rgba(0, 0, 0, .3);
      margin-top: 20px;
    }

    .battle-field {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 40px;
      gap: 40px;
    }

    .fighter {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .fighter-avatar {
      width: 180px;
      height: 180px;
      margin: 0 auto 20px;
      position: relative;
      animation: fighterBounce 2s ease-in-out infinite;
    }

    @keyframes fighterBounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .fighter-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: pixelated;
      filter: drop-shadow(0 10px 30px rgba(0, 0, 0, .5));
    }

    .fighter-avatar.attacking {
      animation: attackAnimation .5s ease-out;
    }

    @keyframes attackAnimation {
      0% {
        transform: translateX(0) scale(1);
      }

      25% {
        transform: translateX(50px) scale(1.1);
      }

      50% {
        transform: translateX(40px) scale(1.05);
      }

      100% {
        transform: translateX(0) scale(1);
      }
    }

    .fighter-avatar.damaged {
      animation: damageAnimation .5s ease-out;
    }

    @keyframes damageAnimation {

      0%,
      100% {
        filter: brightness(1) drop-shadow(0 10px 30px rgba(0, 0, 0, .5));
      }

      25%,
      75% {
        filter: brightness(2) saturate(0) drop-shadow(0 10px 30px rgba(255, 0, 0, .8));
      }

      50% {
        filter: brightness(.5) saturate(0) drop-shadow(0 10px 30px rgba(255, 0, 0, 1));
      }
    }

    .fighter-info {
      background: linear-gradient(135deg, rgba(0, 0, 0, .4), rgba(0, 0, 0, .2));
      border-radius: 20px;
      padding: 20px;
      border: 2px solid rgba(255, 255, 255, .2);
      backdrop-filter: blur(10px);
    }

    .fighter-name {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      margin-bottom: 15px;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
    }

    .fighter.player1 .fighter-name {
      color: var(--primary-yellow);
    }

    .fighter.player2 .fighter-name {
      color: var(--primary-blue);
    }

    .combo-indicator {
      font-size: 20px;
      color: var(--gold);
      margin-top: 10px;
      min-height: 30px;
      font-family: 'Press Start 2P', cursive;
    }

    .combo-indicator.active {
      animation: comboFlash .5s ease-out;
    }

    @keyframes comboFlash {
      0% {
        transform: scale(1);
        text-shadow: 0 0 10px rgba(255, 204, 0, .5);
      }

      50% {
        transform: scale(1.2);
        text-shadow: 0 0 20px rgba(255, 204, 0, 1);
      }

      100% {
        transform: scale(1);
        text-shadow: 0 0 10px rgba(255, 204, 0, .5);
      }
    }

    /* Question Area */
    .question-area {
      background: linear-gradient(135deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
      border: 2px solid rgba(255, 255, 255, .3);
      border-radius: 25px;
      padding: 35px;
      margin-bottom: 30px;
      position: relative;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, .3), inset 0 0 30px rgba(255, 204, 0, .05);
    }

    .turn-indicator {
      text-align: center;
      margin-bottom: 25px;
      font-family: 'Press Start 2P', cursive;
      font-size: 20px;
      color: var(--gold);
      animation: pulse 1s ease-in-out infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        text-shadow: 0 0 10px rgba(255, 204, 0, .5);
      }

      50% {
        opacity: .6;
        text-shadow: 0 0 20px rgba(255, 204, 0, .8);
      }
    }

    .question-text {
      font-size: 32px;
      text-align: center;
      margin-bottom: 35px;
      line-height: 1.5;
      color: var(--text-light);
      font-weight: bold;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .3);
    }

    .answer-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .answer-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, .15), rgba(255, 255, 255, .08));
      border: 2px solid rgba(255, 255, 255, .4);
      border-radius: 20px;
      padding: 25px;
      font-size: 24px;
      color: var(--text-light);
      cursor: pointer;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
      font-family: 'VT323', monospace;
      font-weight: bold;
      position: relative;
      overflow: hidden;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, .3);
    }

    .answer-btn:hover {
      transform: translateY(-5px) scale(1.03);
      border-color: var(--gold);
      box-shadow: 0 15px 40px rgba(255, 204, 0, .3), inset 0 0 20px rgba(255, 204, 0, .1);
    }

    .answer-btn.correct {
      background: linear-gradient(135deg, rgba(0, 255, 136, .4), rgba(0, 255, 136, .2));
      border-color: var(--success);
      animation: correctPulse .6s ease-out;
    }

    @keyframes correctPulse {
      0% {
        transform: scale(1);
      }

      25% {
        transform: scale(1.1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .answer-btn.wrong {
      background: linear-gradient(135deg, rgba(255, 51, 102, .4), rgba(255, 51, 102, .2));
      border-color: var(--danger);
      animation: wrongShake .5s ease-out;
    }

    @keyframes wrongShake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-10px);
      }

      40% {
        transform: translateX(10px);
      }

      60% {
        transform: translateX(-5px);
      }

      80% {
        transform: translateX(5px);
      }
    }

    .answer-btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    /* Buttons */
    .btn {
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      font-weight: 700;
      padding: 18px 40px;
      background: linear-gradient(135deg, var(--primary-yellow), var(--primary-red));
      border: none;
      border-radius: 30px;
      color: #fff;
      cursor: pointer;
      transition: all .3s cubic-bezier(.4, 0, .2, 1);
      text-transform: uppercase;
      letter-spacing: 3px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(255, 0, 68, .3), 0 0 0 2px rgba(255, 255, 255, .1);
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 40px rgba(255, 0, 68, .5), 0 0 0 3px rgba(255, 255, 255, .2);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-container {
      text-align: center;
      margin-top: 40px;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 16px;
      padding: 12px 25px;
      background: rgba(255, 255, 255, .1);
      border: 2px solid rgba(255, 255, 255, .3);
      box-shadow: none;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, .2);
      box-shadow: 0 5px 20px rgba(255, 255, 255, .2);
    }

    /* Difficulty buttons */
    .difficulty-btn {
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 14px 18px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      color: #fff;
    }

    .difficulty-btn:hover {
      transform: translateY(-2px);
      border-color: var(--gold);
    }

    .difficulty-btn.selected {
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.25), 0 16px 30px rgba(255, 204, 0, 0.25);
      background: linear-gradient(135deg, rgba(255, 204, 0, 0.25), rgba(255, 0, 68, 0.12));
    }

    /* Damage effect */
    .damage-number {
      position: absolute;
      font-family: 'Press Start 2P', cursive;
      font-size: 36px;
      color: var(--danger);
      text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
      animation: damageFloat 1.2s ease-out forwards;
      pointer-events: none;
      z-index: 100;
    }

    @keyframes damageFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(.5);
      }

      30% {
        opacity: 1;
        transform: translateY(-40px) scale(1.3);
      }

      100% {
        opacity: 0;
        transform: translateY(-80px) scale(.8);
      }
    }

    .critical-hit {
      color: var(--gold) !important;
      font-size: 52px !important;
    }

    /* Result Screen */
    .result-screen {
      text-align: center;
      padding: 50px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
      border: 3px solid rgba(255, 204, 0, .5);
      border-radius: 30px;
      margin-top: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 80px rgba(255, 204, 0, .3), inset 0 0 50px rgba(255, 204, 0, .1);
    }

    .winner-text {
      font-family: 'Press Start 2P', cursive;
      font-size: 56px;
      margin-bottom: 30px;
      background: linear-gradient(45deg, var(--gold), var(--primary-yellow), var(--primary-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: winnerPulse 1s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(255, 204, 0, .5);
    }

    @keyframes winnerPulse {

      0%,
      100% {
        transform: scale(1);
        filter: brightness(1);
      }

      50% {
        transform: scale(1.08);
        filter: brightness(1.2);
      }
    }

    .winner-name {
      font-size: 42px;
      color: var(--gold);
      margin-bottom: 40px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 3px 3px 0 rgba(0, 0, 0, .3);
    }

    .final-stats {
      display: flex;
      justify-content: center;
      gap: 60px;
      margin-bottom: 40px;
    }

    .final-stat {
      text-align: center;
      background: rgba(0, 0, 0, .3);
      padding: 20px 30px;
      border-radius: 20px;
      border: 2px solid rgba(255, 204, 0, .3);
    }

    .final-stat-label {
      font-size: 20px;
      color: var(--text-dim);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .final-stat-value {
      font-family: 'Press Start 2P', cursive;
      font-size: 36px;
      color: var(--gold);
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .5);
    }

    /* Responsive */
    @media (max-width:768px) {
      .game-logo {
        font-size: 48px;
      }

      .start-button {
        font-size: 20px;
        padding: 15px 40px;
      }

      .game-title {
        font-size: 28px;
      }

      .character-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .answer-options {
        grid-template-columns: 1fr;
      }

      .battle-field {
        flex-direction: column;
        gap: 30px;
      }

      .final-stats {
        flex-direction: column;
        gap: 20px;
      }

      .mode-buttons {
        flex-direction: column;
        align-items: center;
      }

      .hud-player {
        flex-direction: column;
        align-items: flex-start;
      }

      .hud-player.p2 {
        align-items: flex-end;
      }
    }

    @media (max-width:480px) {
      .game-logo {
        font-size: 36px;
      }

      .character-grid {
        grid-template-columns: 1fr;
      }

      .fighter-avatar {
        width: 120px;
        height: 120px;
      }
    }

    /* ===== TUTORIAL OVERLAY ===== */
    #tutorialOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
    }

    .tuto-card {
      width: min(900px, 95vw);
      background: linear-gradient(135deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .05));
      border: 2px solid rgba(255, 204, 0, .4);
      border-radius: 24px;
      padding: 26px;
    }

    .tuto-title {
      font-family: 'Press Start 2P', cursive;
      color: var(--gold);
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
    }

    /* ===== MINI FIGHT DEMO ===== */
    .mini-fight {
      background: rgba(0, 0, 0, .35);
      border-radius: 18px;
      padding: 16px;
    }

    .mini-arena {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mini-fighter {
      width: 120px;
      text-align: center;
    }

    .mini-avatar {
      width: 96px;
      image-rendering: pixelated;
    }

    .mini-avatar.attack {
      animation: miniAtk .6s ease-out;
    }

    .mini-avatar.hit {
      animation: miniHit .4s ease-out;
    }

    @keyframes miniAtk {
      50% {
        transform: translateX(22px) scale(1.1);
      }
    }

    @keyframes miniHit {
      30% {
        filter: brightness(2) grayscale(1);
      }
    }

    .mini-hp {
      height: 8px;
      background: rgba(255, 255, 255, .15);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 6px;
    }

    .mini-hp-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc66);
      transition: width .4s ease;
    }

    .mini-vs {
      font-family: 'Press Start 2P', cursive;
      color: var(--gold);
    }

    .mini-caption {
      text-align: center;
      margin-top: 12px;
      font-size: 18px;
      color: var(--text-dim);
    }

    .tuto-actions {
      text-align: center;
      margin-top: 18px;
    }

    /* make caption the hero */
    .mini-caption {
      font-family: 'VT323', monospace;
      font-size: 28px;
      /* ÂéüÊù•18Â§™Â∞è */
      line-height: 1.25;
      color: #fff;
      /* ÂéüÊù• var(--text-dim) Â§™Ê∑° */
      text-shadow: 2px 2px 0 rgba(0, 0, 0, .35);
      min-height: 44px;
      /* Èò≤Ê≠¢ÊñáÂ≠óÂàáÊç¢Êó∂Ë∑≥Âä® */
    }

    /* action row layout */
    .tuto-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      margin-top: 18px;
    }

    .tuto-step {
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      color: rgba(255, 255, 255, .75);
      padding: 10px 12px;
      border: 2px solid rgba(255, 255, 255, .15);
      border-radius: 14px;
      background: rgba(0, 0, 0, .25);
    }

    .tuto-skip {
      background: rgba(255, 255, 255, .08);
      border: 2px solid rgba(255, 255, 255, .2);
      box-shadow: none;
    }

    .tuto-next {
      /* Ê≤øÁî® btn ÁöÑÊ∏êÂèòÂç≥ÂèØÔºå‰∏çÁî®È¢ùÂ§ñÊîπ */
    }

    /* slow down the mini demo a bit */
    .mini-avatar.attack {
      animation: miniAtk 1.0s ease-out;
    }

    .mini-avatar.hit {
      animation: miniHit .7s ease-out;
    }
  </style>
</head>

<body>
  <!-- Cover Screen -->
  <div class="cover-screen" id="coverScreen">
    <img src="cover.png" alt="T3 Battle" class="cover-image" />
    <div class="cover-overlay"></div>
    <div class="cover-content">
      <div class="game-logo"><span class="t3">T3</span> <span class="battle">Battle</span></div>
      <button class="start-button" onclick="startGame()">START</button>
    </div>
    <div class="press-start-text">PRESS START</div>
  </div>

  <!-- Main Game Container -->
  <div class="game-container" id="gameContainer">
    <div class="container">
      <div class="game-header">
        <div class="game-title">T3 Battle</div>
        <div class="game-subtitle">FIGHTING ARENA</div>
      </div>

      <!-- Mode Selection Screen -->
      <div id="modeScreen" class="screen active">
        <div class="mode-screen">
          <div class="mode-title">SELECT MODE</div>

          <div class="mode-buttons">
            <div class="mode-button" onclick="selectMode('solo')">
              <div class="mode-icon">ü§ñ</div>
              <div class="mode-name">SOLO</div>
              <div class="mode-desc">VS AI</div>
            </div>
            <div class="mode-button" onclick="selectMode('duo')">
              <div class="mode-icon">üë•</div>
              <div class="mode-name">DUO</div>
              <div class="mode-desc">LOCAL 2P</div>
            </div>
          </div>

          <!-- Options Panel (NEW) -->
          <div style="margin-top:50px; display:flex; justify-content:center; gap:30px; flex-wrap:wrap;">
            <!-- SOLO difficulty -->
            <div id="difficultySelection" style="display:none; text-align:center;">
              <div style="font-family:'Press Start 2P',cursive; font-size:16px; color:var(--gold); margin-bottom:12px;">
                AI DIFFICULTY
              </div>
              <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                <button class="difficulty-btn" onclick="selectDifficulty('easy', event)">EASY</button>
                <button class="difficulty-btn" onclick="selectDifficulty('normal', event)">NORMAL</button>
                <button class="difficulty-btn" onclick="selectDifficulty('hard', event)">HARD</button>
              </div>
            </div>

            <!-- DUO options -->
            <div id="duoOptions" style="display:none; text-align:center;">
              <div style="font-family:'Press Start 2P',cursive; font-size:16px; color:var(--gold); margin-bottom:12px;">
                DUO OPTIONS
              </div>
              <div style="display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap;">
                <div style="display:flex; gap:10px; align-items:center;">
                  <button class="btn" id="buzzToggle" onclick="toggleBuzz()">BUZZ</button>
                  <div style="font-family:'Press Start 2P',cursive; font-size:12px; color:var(--text-dim);">
                    A = P1 / L = P2 (<span id="buzzStatus">OFF</span>)
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Options Panel end -->
        </div>
        <div class="btn-container" style="margin-top:30px;">
          <button class="btn" id="continueBtn" onclick="goToCharacterSelect()" style="display:none;">
            CONTINUE
          </button>
        </div>
      </div>

      <!-- Character Selection Screen -->
      <div id="characterScreen" class="screen">
        <button class="btn back-btn" onclick="backToMode()">BACK</button>
        <div class="character-selection-container">
          <div class="selection-title">CHOOSE YOUR FIGHTER</div>
          <div id="playerTurnIndicator" class="player-turn-indicator" style="display:none;"></div>

          <div class="character-showcase">
            <div class="character-grid" id="characterGrid"></div>
            <div class="btn-container">
              <button class="btn" id="startBattleBtn" onclick="startBattle()" disabled>START BATTLE</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Battle Screen -->
      <div id="battleScreen" class="screen">
        <button class="btn back-btn" onclick="backToSelection()">BACK</button>

        <div class="battle-container">
          <div class="battle-hud">
            <div class="hud-player p1">
              <div class="hud-avatar"><img id="hudP1Img" src="" alt="" /></div>
              <div class="hud-info">
                <div class="hud-name" id="hudP1Name">PLAYER 1</div>
                <div class="hud-hp-bar">
                  <div class="hud-hp-ghost" id="hudP1Ghost" style="width:100%"></div>
                  <div class="hud-hp-fill" id="hudP1HP" style="width:100%"></div>
                  <span class="hud-hp-text" id="hudP1Text">100/100</span>
                </div>

                <!-- Energy P1 -->
                <div style="margin-top:8px;">
                  <div style="font-family:'Press Start 2P',cursive; font-size:10px; color:var(--text-dim); margin-bottom:4px;">
                    ENERGY: <span id="hudP1EnergyText">0</span>/100
                  </div>
                  <div style="width:200px; height:10px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2);">
                    <div id="hudP1Energy" style="height:100%; width:0%; background:linear-gradient(90deg, #0088ff, #ffcc00); transition:width 0.3s ease;"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="hud-center">
              <div class="round-indicator">ROUND 1</div>
              <div class="hud-timer" id="hudTimer">30</div>
            </div>

            <div class="hud-player p2">
              <div class="hud-avatar"><img id="hudP2Img" src="" alt="" /></div>
              <div class="hud-info p2">
                <div class="hud-name" id="hudP2Name">PLAYER 2</div>
                <div class="hud-hp-bar">
                  <div class="hud-hp-ghost" id="hudP2Ghost" style="width:100%"></div>
                  <div class="hud-hp-fill" id="hudP2HP" style="width:100%"></div>
                  <span class="hud-hp-text" id="hudP2Text">100/100</span>
                </div>

                <!-- Energy P2 -->
                <div style="margin-top:8px;">
                  <div style="font-family:'Press Start 2P',cursive; font-size:10px; color:var(--text-dim); margin-bottom:4px;">
                    ENERGY: <span id="hudP2EnergyText">0</span>/100
                  </div>
                  <div style="width:200px; height:10px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2);">
                    <div id="hudP2Energy" style="height:100%; width:0%; background:linear-gradient(90deg, #0088ff, #ffcc00); transition:width 0.3s ease;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="battle-arena">
            <div class="battle-field">
              <div class="fighter player1">
                <div class="fighter-avatar" id="fighter1Avatar"><img id="fighter1Img" src="" alt="" /></div>
                <div class="fighter-info">
                  <div class="fighter-name" id="fighter1Name"></div>
                  <div class="combo-indicator" id="fighter1Combo"></div>
                </div>
              </div>

              <div class="fighter player2">
                <div class="fighter-avatar" id="fighter2Avatar"><img id="fighter2Img" src="" alt="" /></div>
                <div class="fighter-info">
                  <div class="fighter-name" id="fighter2Name"></div>
                  <div class="combo-indicator" id="fighter2Combo"></div>
                </div>
              </div>
            </div>

            <div class="question-area">
              <div class="turn-indicator" id="turnIndicator"></div>

              <!-- Stance Selection (NEW) -->
              <div id="stanceSelection" style="display:none; text-align:center; margin:20px 0;">
                <div style="font-family:'Press Start 2P',cursive; font-size:14px; color:var(--gold); margin-bottom:12px;">
                  CHOOSE ACTION
                </div>

                <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                  <button class="btn stance-btn selected" onclick="selectStance('attack', event)">ATTACK</button>
                  <button class="btn stance-btn" onclick="selectStance('defend', event)">DEFEND</button>
                  <button class="btn stance-btn" onclick="selectStance('dodge', event)">DODGE</button>
                  <button class="btn stance-btn" onclick="selectStance('gamble', event)">GAMBLE</button>
                  <button class="btn stance-btn" id="specialBtn" style="display:none;" onclick="useSpecial(event)">SPECIAL</button>
                </div>

                <div id="stanceHint" style="margin-top:10px; font-size:18px; color:var(--text-dim);">
                  ATTACK = normal / DEFEND = reduce incoming / DODGE = chance avoid / GAMBLE = high risk
                </div>
              </div>

              <!-- Buzz Indicator (NEW) -->
              <div id="buzzIndicator" style="display:none; text-align:center; margin:10px 0; font-family:'Press Start 2P',cursive; font-size:14px; color:var(--gold);">
                BUZZ NOW! (A = P1, L = P2)
              </div>

              <div class="question-text" id="questionText"></div>
              <div class="answer-options" id="answerOptions"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Result Screen -->
      <div id="resultScreen" class="screen">
        <div class="result-screen">
          <div class="winner-text" id="winnerTitle">VICTORY!</div>
          <div class="winner-name" id="winnerName"></div>
          <div id="resultModeText" style="
  font-family:'Press Start 2P', cursive;
  font-size:14px;
  color:rgba(255,255,255,0.85);
  margin: 10px 0 30px;
  letter-spacing:2px;">
          </div>
          <div class="final-stats">
            <div class="final-stat">
              <div class="final-stat-label">CORRECT</div>
              <div class="final-stat-value" id="correctAnswers">0</div>
            </div>
            <div class="final-stat">
              <div class="final-stat-label">DAMAGE</div>
              <div class="final-stat-value" id="totalDamage">0</div>
            </div>
            <div class="final-stat">
              <div class="final-stat-label">MAX COMBO</div>
              <div class="final-stat-value" id="maxCombo">0</div>
            </div>
          </div>
          <div class="btn-container">
            <button class="btn" onclick="resetGame()">PLAY AGAIN</button>
          </div>
        </div>
      </div>

    </div>
    <!-- ===== Tutorial Overlay START ===== -->
    <div id="tutorialOverlay" style="display:none;">
      <div class="tuto-card">

        <div class="tuto-title">HOW TO FIGHT</div>

        <!-- Mini Fight Demo -->
        <div class="mini-fight">
          <div class="mini-arena">

            <div class="mini-fighter left">
              <img src="Henry.gif" class="mini-avatar" id="miniP1">
              <div class="mini-hp">
                <div class="mini-hp-fill" id="miniHP1"></div>
              </div>
            </div>

            <div class="mini-vs">VS</div>

            <div class="mini-fighter right">
              <img src="Randy.gif" class="mini-avatar" id="miniP2">
              <div class="mini-hp">
                <div class="mini-hp-fill" id="miniHP2"></div>
              </div>
            </div>

          </div>

          <div class="mini-caption" id="miniCaption">
            ATTACK: Correct answer deals damage
          </div>
        </div>

        <div class="tuto-actions">
          <button class="btn tuto-skip" onclick="skipTutorial()">SKIP</button>
          <div class="tuto-step" id="tutoStepText">1 / 5</div>
          <button class="btn tuto-next" onclick="nextTutorialStep()">NEXT</button>
        </div>

      </div>
    </div>
    <!-- ===== Tutorial Overlay END ===== -->
  </div>

  <script>
    // =========================
    // Game State
    // =========================
    let gameState = {
      mode: null, // 'solo' | 'duo'
      difficulty: 'easy', // easy | normal | hard
      buzzMode: false,
      buzzWinner: null, // 1 | 2 | null
      currentTurn: 1, // 1 | 2
      selectingPlayer: 1, // for duo character selection
      player1: null,
      player2: null,
      player1Health: 100,
      player2Health: 100,
      player1MaxHealth: 100,
      player2MaxHealth: 100,
      player1Energy: 0,
      player2Energy: 0,
      player1Combo: 0,
      player2Combo: 0,
      player1Stance: 'attack',
      player2Stance: 'attack',
      player1Stats: {
        correct: 0,
        totalDamage: 0,
        maxCombo: 0
      },
      player2Stats: {
        correct: 0,
        totalDamage: 0,
        maxCombo: 0
      },
      timer: null,
      timeLeft: 30
    };
    // ===== NEW CONFIG =====
    const gameConfig = {
      energy: {
        maxEnergy: 100,
        gainOnCorrect: 25
      },
      special: {
        damageMultiplier: 2.2,
        energyCost: 100
      },
      difficulty: {
        easy: {
          accuracy: 0.55,
          reactionDelay: {
            min: 900,
            max: 1400
          }
        },
        normal: {
          accuracy: 0.70,
          reactionDelay: {
            min: 700,
            max: 1200
          }
        },
        hard: {
          accuracy: 0.85,
          reactionDelay: {
            min: 450,
            max: 900
          }
        }
      }
    };
    const stanceConfig = {
      attack: {
        attackMultiplier: 1.00,
        incomingMultiplier: 1.00,
        dodgeChance: 0.00,
        gambleSelfPenaltyOnWrong: 0
      },
      defend: {
        attackMultiplier: 0.95,
        incomingMultiplier: 0.65,
        dodgeChance: 0.00,
        gambleSelfPenaltyOnWrong: 0
      },
      dodge: {
        attackMultiplier: 0.90,
        incomingMultiplier: 1.00,
        dodgeChance: 0.40,
        gambleSelfPenaltyOnWrong: 0
      },
      gamble: {
        attackMultiplier: 1.35,
        incomingMultiplier: 1.05,
        dodgeChance: 0.00,
        gambleSelfPenaltyOnWrong: 12
      }
    };

    function getActingPlayer() {
      if (gameState.mode === 'duo' && gameState.buzzMode && gameState.buzzWinner !== null) return gameState.buzzWinner;
      return gameState.currentTurn;
    }

    function getOtherPlayer(p) {
      return p === 1 ? 2 : 1;
    }

    function getPlayerChar(p) {
      return p === 1 ? gameState.player1 : gameState.player2;
    }

    function getPlayerStance(p) {
      return p === 1 ? gameState.player1Stance : gameState.player2Stance;
    }

    function setPlayerStance(p, s) {
      if (p === 1) gameState.player1Stance = s;
      else gameState.player2Stance = s;
    }
    // =========================
    // Character Data
    // =========================
    const characters = [{
        id: 'henry',
        name: 'Henry',
        image: 'Henry.gif',
        health: 100,
        attack: 35,
        defense: 20,
        special: 'Speed Type'
      },
      {
        id: 'eason',
        name: 'Eason',
        image: 'Eason.gif',
        health: 90,
        attack: 30,
        defense: 25,
        special: 'Balanced'
      },
      {
        id: 'jason',
        name: 'Jason',
        image: 'Jason.gif',
        health: 120,
        attack: 25,
        defense: 35,
        special: 'Defense Type'
      },
      {
        id: 'joey',
        name: 'Joey',
        image: 'Joey.gif',
        health: 110,
        attack: 28,
        defense: 30,
        special: 'Endurance'
      },
      {
        id: 'quan',
        name: 'Quan',
        image: 'Quan.gif',
        health: 95,
        attack: 32,
        defense: 22,
        special: 'Technical'
      },
      {
        id: 'randy',
        name: 'Randy',
        image: 'Randy.gif',
        health: 85,
        attack: 40,
        defense: 15,
        special: 'Critical'
      },
      {
        id: 'mark',
        name: 'Mark',
        image: 'Mark.gif',
        health: 105,
        attack: 30,
        defense: 28,
        special: 'All-Round'
      },
      {
        id: 'maximus',
        name: 'Maximus',
        image: 'Maximus.gif',
        health: 115,
        attack: 27,
        defense: 32,
        special: 'Tank'
      },
      {
        id: 'bruce',
        name: 'Bruce',
        image: 'Bruce.gif',
        health: 100,
        attack: 33,
        defense: 25,
        special: 'Fighter'
      }
    ];
    // =========================
    // Question Bank (external JSON)
    // =========================
    let QUESTION_BANK = [];
    let questionHistory = [];
    const MAX_HISTORY = 6;
    async function loadQuestionBank() {
      const response = await fetch('./questionBank_unit1-4.json', {
        cache: 'no-store'
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      if (!Array.isArray(data) || data.length === 0) throw new Error('Question bank invalid or empty');
      const valid = data.filter(q => {
        if (!q.question || !q.type) return false;
        if (q.type === 'choice') {
          return Array.isArray(q.options) && q.options.length === 4 && typeof q.correct === 'number';
        }
        if (q.type === 'fill') return !!q.answer;
        return false;
      });
      if (valid.length === 0) throw new Error('No valid questions found');
      console.log(`Loaded ${valid.length} questions`);
      return valid;
    }

    function showLoadError(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position:fixed; inset:0;
        background:rgba(0,0,0,0.92);
        display:flex; flex-direction:column;
        justify-content:center; align-items:center;
        z-index:99999;
        font-family:'Press Start 2P', cursive;
        color:#ff0044;
        text-align:center;
        padding:24px;
      `;
      overlay.innerHTML = `
        <div style="font-size:32px; margin-bottom:24px;">ERROR!</div>
        <div style="font-size:14px; line-height:1.6; max-width:720px; margin-bottom:24px;">
          FAILED TO LOAD QUESTION BANK<br><br>
          ${message}<br><br>
          Make sure <span style="color:#ffcc00;">questionBank_unit1-4.json</span> is in the same folder as this HTML.
        </div>
        <button class="btn" onclick="location.reload()">RELOAD</button>
      `;
      document.body.appendChild(overlay);
    }

    function getQuestion() {
      if (QUESTION_BANK.length === 0) return null;
      let pool = QUESTION_BANK.filter(q => q.type === 'choice'); // only choice for now
      // difficulty filter for solo mode (if JSON has q.difficulty: 1/2/3)
      if (gameState.mode === 'solo') {
        const level = gameState.difficulty;
        let targets = [];
        if (level === 'easy') targets = [1];
        if (level === 'normal') targets = [1, 2];
        if (level === 'hard') targets = [2, 3];
        const filtered = pool.filter(q => q.difficulty && targets.includes(q.difficulty));
        if (filtered.length >= 8) pool = filtered;
      }
      // avoid repeats
      let available = pool.filter(q => !questionHistory.some(h => (h.id && q.id && h.id === q.id) || h.question === q.question));
      if (available.length < 3) {
        questionHistory = questionHistory.slice(-2);
        available = pool.filter(q => !questionHistory.some(h => h.question === q.question));
      }
      const pick = available[Math.floor(Math.random() * available.length)];
      questionHistory.push(pick);
      if (questionHistory.length > MAX_HISTORY) questionHistory.shift();
      return pick;
    }
    // =========================
    // Screen helpers
    // =========================
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    }
    // =========================
    // Init
    // =========================
    async function startGame() {
      try {
        QUESTION_BANK = await loadQuestionBank();
        document.getElementById('coverScreen').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('coverScreen').style.display = 'none';
          document.getElementById('gameContainer').classList.add('active');
          showScreen('modeScreen');
        }, 500);
      } catch (e) {
        console.error(e);
        showLoadError(e.message);
      }
    }

    function init() {
      document.addEventListener('keydown', handleBuzzKey);
    }
    // =========================
    // Mode / Options
    // =========================
    function selectMode(mode) {
      gameState.mode = mode;
      gameState.selectingPlayer = 1;
      gameState.currentTurn = 1;
      gameState.buzzWinner = null;
      const diff = document.getElementById('difficultySelection');
      const duo = document.getElementById('duoOptions');
      if (mode === 'solo') {
        diff.style.display = 'block';
        duo.style.display = 'none';
      } else {
        diff.style.display = 'none';
        duo.style.display = 'block';
      }
      document.getElementById('continueBtn').style.display = 'inline-block';
    }

    function goToCharacterSelect() {
      showScreen('characterScreen');
      renderCharacters();
      const indicator = document.getElementById('playerTurnIndicator');
      if (gameState.mode === 'duo') {
        indicator.style.display = 'block';
        indicator.className = 'player-turn-indicator player1';
        indicator.textContent = 'PLAYER 1 SELECT';
      } else {
        indicator.style.display = 'none';
      }
    }

    function selectDifficulty(level, ev) {
      gameState.difficulty = level;
      document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
      if (ev && ev.target) ev.target.classList.add('selected');
      console.log('Difficulty selected:', level);
    }

    function toggleBuzz() {
      gameState.buzzMode = !gameState.buzzMode;
      const toggle = document.getElementById('buzzToggle');
      const status = document.getElementById('buzzStatus');
      if (gameState.buzzMode) {
        toggle.classList.add('active');
        status.textContent = 'ON';
      } else {
        toggle.classList.remove('active');
        status.textContent = 'OFF';
      }
    }

    function backToMode() {
      resetGameState();
      showScreen('modeScreen');
      document.getElementById('difficultySelection').style.display = 'none';
      document.getElementById('duoOptions').style.display = 'none';
    }
    // =========================
    // Character Selection
    // =========================
    function renderCharacters() {
      const grid = document.getElementById('characterGrid');
      grid.innerHTML = '';
      characters.forEach(char => grid.appendChild(createCharacterCard(char)));
    }

    function createCharacterCard(character) {
      const card = document.createElement('div');
      card.className = 'character-card';
      card.dataset.characterId = character.id;
      card.innerHTML = `
        <div class="character-avatar"><img src="${character.image}" alt="${character.name}"></div>
        <div class="character-name">${character.name}</div>
        <div class="character-stats">
          <div class="stat"><span class="stat-name">HP</span><div class="stat-bar"><div class="stat-fill health" style="width:${character.health}%"></div></div></div>
          <div class="stat"><span class="stat-name">ATK</span><div class="stat-bar"><div class="stat-fill attack" style="width:${character.attack*2}%"></div></div></div>
          <div class="stat"><span class="stat-name">DEF</span><div class="stat-bar"><div class="stat-fill defense" style="width:${character.defense*2}%"></div></div></div>
        </div>
      `;
      card.addEventListener('click', () => selectCharacter(character, card));
      return card;
    }

    function selectCharacter(character, el) {
      if (!el || el.classList.contains('disabled')) return;
      if (gameState.mode === 'solo') {
        document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        gameState.player1 = character;
        const available = characters.filter(c => c.id !== character.id);
        gameState.player2 = available[Math.floor(Math.random() * available.length)];
        document.getElementById('startBattleBtn').disabled = false;
        return;
      }
      // duo
      if (gameState.selectingPlayer === 1) {
        document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        gameState.player1 = character;
        gameState.selectingPlayer = 2;
        // disable p1 picked character for p2
        document.querySelectorAll('.character-card').forEach(card => {
          if (card.dataset.characterId === character.id) card.classList.add('disabled');
        });
        const indicator = document.getElementById('playerTurnIndicator');
        indicator.style.display = 'block';
        indicator.className = 'player-turn-indicator player2';
        indicator.textContent = 'PLAYER 2 SELECT';
        return;
      }
      if (gameState.selectingPlayer === 2) {
        if (gameState.player1 && character.id === gameState.player1.id) return;
        el.classList.add('selected');
        gameState.player2 = character;
        document.getElementById('startBattleBtn').disabled = false;
        document.getElementById('playerTurnIndicator').style.display = 'none';
      }
    }

    function backToSelection() {
      // keep mode options, but reset battle-related state
      clearInterval(gameState.timer);
      gameState.currentTurn = 1;
      gameState.buzzWinner = null;
      gameState.player1Health = 100;
      gameState.player2Health = 100;
      showScreen('characterScreen');
      renderCharacters();
      document.getElementById('startBattleBtn').disabled = !(gameState.player1 && gameState.player2);
    }
    // =========================
    // Battle Flow
    // =========================
    function startBattle() {
      if (!gameState.player1 || !gameState.player2) return;
      showScreen('battleScreen');
      initializeBattle();
      if (!tutorialShown) {
        tutorialShown = true;
        openTutorial();
      } else {
        nextQuestion();
      }
    }
    let tutorialShown = false;
    let miniStep = 0;
    let miniDemoTimer = null;

    function openTutorial() {
      miniStep = 0; // ÊØèÊ¨°ÊâìÂºÄÈÉΩ‰ªéÁ¨¨‰∏ÄÊ≠•ÂºÄÂßã
      document.getElementById('tutorialOverlay').style.display = 'flex';
      startMiniDemo();
    }

    function closeTutorial() {
      stopMiniDemo();
      document.getElementById('tutorialOverlay').style.display = 'none';
      nextQuestion();
    }

    function startMiniDemo() {
      // ‰∏çË¶ÅËá™Âä®ËΩÆÊí≠ÔºåÂè™ÊòæÁ§∫ÂΩìÂâç step
      renderMiniStep();
    }

    function stopMiniDemo() {
      if (miniDemoTimer) clearInterval(miniDemoTimer);
      miniDemoTimer = null;
    }

    function renderMiniStep() {
      const p1 = document.getElementById('miniP1');
      const p2 = document.getElementById('miniP2');
      const hp1 = document.getElementById('miniHP1');
      const hp2 = document.getElementById('miniHP2');
      const caption = document.getElementById('miniCaption');
      const stepText = document.getElementById('tutoStepText');
      // reset visuals
      p1.className = 'mini-avatar';
      p2.className = 'mini-avatar';
      hp1.style.width = '100%';
      hp2.style.width = '100%';
      const steps = [
        () => {
          caption.textContent = 'ATTACK: Correct answer deals damage';
          p1.classList.add('attack');
          p2.classList.add('hit');
          hp2.style.width = '70%';
        },
        () => {
          caption.textContent = 'DEFEND: Damage is reduced';
          p2.classList.add('attack');
          hp1.style.width = '90%';
        },
        () => {
          caption.textContent = 'DODGE: Chance to avoid damage';
          p1.classList.add('attack'); /* ÂèØÂä† miss ÁâπÊïà */
        },
        () => {
          caption.textContent = 'GAMBLE: High risk, high reward';
          p2.classList.add('attack');
          p2.classList.add('hit');
          hp2.style.width = '40%';
        },
        () => {
          caption.textContent = 'COMBO: Streak = more damage';
          p1.classList.add('attack');
          p2.classList.add('hit');
          hp2.style.width = '0%';
        }
      ];
      // render current step
      steps[miniStep]();
      // progress text (1/5)
      if (stepText) stepText.textContent = `${miniStep + 1} / ${steps.length}`;
    }

    function nextTutorialStep() {
      const total = 5; // steps length
      miniStep = Math.min(miniStep + 1, total); // ÂÖàÂä†ÔºåÂêéÂà§Êñ≠ÁªìÊùü
      if (miniStep >= total) {
        closeTutorial(); // ÁªìÊùüÔºöËøõÂÖ•Ê∏∏Êàè
        return;
      }
      renderMiniStep();
    }

    function skipTutorial() {
      // Ë∑≥Ëøá tutorialÔºö‰∏çÁÆ°ÂΩìÂâçÂú®Âì™‰∏ÄÊ≠•ÔºåÁõ¥Êé•ÂºÄÂßãÊ∏∏Êàè
      miniStep = 0;
      closeTutorial();
    }

    function initializeBattle() {
      document.getElementById('hudP1Name').textContent = gameState.player1.name;
      document.getElementById('hudP1Img').src = gameState.player1.image;
      document.getElementById('hudP2Name').textContent = (gameState.mode === 'solo') ? `AI ${gameState.player2.name}` : gameState.player2.name;
      document.getElementById('hudP2Img').src = gameState.player2.image;
      document.getElementById('fighter1Name').textContent = gameState.player1.name;
      document.getElementById('fighter1Img').src = gameState.player1.image;
      document.getElementById('fighter2Name').textContent = (gameState.mode === 'solo') ? `AI ${gameState.player2.name}` : gameState.player2.name;
      document.getElementById('fighter2Img').src = gameState.player2.image;
      gameState.player1Health = gameState.player1.health;
      gameState.player2Health = gameState.player2.health;
      gameState.player1MaxHealth = gameState.player1.health;
      gameState.player2MaxHealth = gameState.player2.health;
      gameState.player1Energy = 0;
      gameState.player2Energy = 0;
      gameState.player1Combo = 0;
      gameState.player2Combo = 0;
      gameState.player1Stance = 'attack';
      gameState.player2Stance = 'attack';
      gameState.buzzWinner = null;
      gameState.currentTurn = 1;
      updateHealthBar(1);
      updateHealthBar(2);
      updateEnergyBar(1);
      updateEnergyBar(2);
      updateComboDisplay(1);
      updateComboDisplay(2);
      document.getElementById('stanceHint').textContent =
        'ATTACK = normal / DEFEND = reduce incoming / DODGE = chance avoid / GAMBLE = high risk';
      document.getElementById('buzzIndicator').style.display =
        (gameState.mode === 'duo' && gameState.buzzMode) ? 'block' : 'none';
    }

    function nextQuestion() {
      if (gameState.player1Health <= 0 || gameState.player2Health <= 0) {
        endGame();
        return;
      }
      clearInterval(gameState.timer);
      gameState.buzzWinner = null;
      document.getElementById('questionText').textContent = '';
      document.getElementById('answerOptions').innerHTML = '';
      document.getElementById('stanceSelection').style.display = 'none';
      document.getElementById('specialBtn').style.display = 'none';
      document.getElementById('stanceHint').textContent =
        'ATTACK = normal / DEFEND = reduce incoming / DODGE = chance avoid / GAMBLE = high risk';
      const turnIndicator = document.getElementById('turnIndicator');
      const buzzIndicator = document.getElementById('buzzIndicator');
      if (gameState.mode === 'duo' && gameState.buzzMode) {
        buzzIndicator.style.display = 'block';
        turnIndicator.textContent = 'WAITING FOR BUZZ...';
        return;
      }
      buzzIndicator.style.display = 'none';
      const acting = getActingPlayer();
      if (gameState.mode === 'solo') {
        turnIndicator.textContent = (acting === 1) ? 'PLAYER TURN' : 'AI TURN';
      } else {
        turnIndicator.textContent = `PLAYER ${acting} TURN`;
      }
      showStancePanelFor(acting);
      if (gameState.mode === 'solo' && acting === 2) {
        const stances = ['attack', 'defend', 'dodge', 'gamble'];
        const pick = stances[Math.floor(Math.random() * stances.length)];
        setTimeout(() => {
          setPlayerStance(2, pick);
          document.getElementById('stanceSelection').style.display = 'none';
          showQuestion();
        }, 650);
      }
    }

    function showStancePanelFor(player) {
      document.querySelectorAll('.stance-btn').forEach(btn => btn.classList.remove('selected'));
      const s = getPlayerStance(player) || 'attack';
      // mark selected
      const map = {
        attack: 'ATTACK',
        defend: 'DEFEND',
        dodge: 'DODGE',
        gamble: 'GAMBLE'
      };
      const btn = Array.from(document.querySelectorAll('.stance-btn'))
        .find(b => b.textContent.trim() === (map[s] || 'ATTACK'));
      if (btn) btn.classList.add('selected');
      const energy = (player === 1) ? gameState.player1Energy : gameState.player2Energy;
      document.getElementById('specialBtn').style.display = (energy >= gameConfig.energy.maxEnergy) ? 'inline-block' : 'none';
      document.getElementById('stanceSelection').style.display = 'block';
    }

    function selectStance(stance, ev) {
      const acting = getActingPlayer();
      setPlayerStance(acting, stance);
      document.querySelectorAll('.stance-btn').forEach(btn => btn.classList.remove('selected'));
      if (ev && ev.target) ev.target.classList.add('selected');
      setTimeout(() => {
        document.getElementById('stanceSelection').style.display = 'none';
        showQuestion();
      }, 200);
    }

    function useSpecial(ev) {
      const acting = getActingPlayer();
      const energy = (acting === 1) ? gameState.player1Energy : gameState.player2Energy;
      if (energy < gameConfig.special.energyCost) return;
      if (acting === 1) gameState.player1Energy = 0;
      else gameState.player2Energy = 0;
      updateEnergyBar(acting);
      document.getElementById('stanceHint').textContent = 'SPECIAL ARMED! Correct answer deals HUGE DAMAGE!';
      if (ev && ev.target) ev.target.blur();
    }

    function showQuestion() {
      const q = getQuestion();
      if (!q) {
        console.error('No question available');
        return;
      }
      document.getElementById('questionText').textContent = q.question;
      const box = document.getElementById('answerOptions');
      box.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = opt;
        btn.onclick = () => {
          if (gameState.mode === 'duo' && gameState.buzzMode && gameState.buzzWinner === null) return;
          checkAnswer(idx, q.correct);
        };
        // Solo AI turn: disable clicks
        if (gameState.mode === 'solo' && getActingPlayer() === 2) btn.disabled = true;
        box.appendChild(btn);
      });
      startTimer();
      // AI answer
      if (gameState.mode === 'solo' && getActingPlayer() === 2) {
        const diff = gameConfig.difficulty[gameState.difficulty || 'easy'];
        const delay = diff.reactionDelay.min + Math.random() * (diff.reactionDelay.max - diff.reactionDelay.min);
        setTimeout(() => {
          const chooseCorrect = Math.random() < diff.accuracy;
          const aiAnswer = chooseCorrect ? q.correct : Math.floor(Math.random() * 4);
          checkAnswer(aiAnswer, q.correct);
        }, delay);
      }
    }

    function startTimer() {
      gameState.timeLeft = 30;
      const timerEl = document.getElementById('hudTimer');
      clearInterval(gameState.timer);
      timerEl.classList.remove('warning');
      timerEl.textContent = gameState.timeLeft;
      gameState.timer = setInterval(() => {
        gameState.timeLeft--;
        timerEl.textContent = gameState.timeLeft;
        if (gameState.timeLeft <= 10) timerEl.classList.add('warning');
        if (gameState.timeLeft <= 0) {
          clearInterval(gameState.timer);
          checkAnswer(-1, -1); // timeout
        }
      }, 1000);
    }

    function checkAnswer(selected, correct) {
      clearInterval(gameState.timer);
      // reveal
      document.querySelectorAll('.answer-btn').forEach((btn, i) => {
        btn.disabled = true;
        if (i === correct) btn.classList.add('correct');
        else if (i === selected && selected !== correct) btn.classList.add('wrong');
      });
      const acting = getActingPlayer();
      const defender = getOtherPlayer(acting);
      const isCorrect = (selected === correct);
      const atkSt = stanceConfig[getPlayerStance(acting) || 'attack'];
      const defSt = stanceConfig[getPlayerStance(defender) || 'attack'];
      if (isCorrect) {
        // combo + stats
        if (acting === 1) {
          gameState.player1Combo++;
          gameState.player1Stats.correct++;
          gameState.player1Stats.maxCombo = Math.max(gameState.player1Stats.maxCombo, gameState.player1Combo);
        } else {
          gameState.player2Combo++;
          gameState.player2Stats.correct++;
          gameState.player2Stats.maxCombo = Math.max(gameState.player2Stats.maxCombo, gameState.player2Combo);
        }
        // base damage
        const attackerChar = getPlayerChar(acting);
        const defenderChar = getPlayerChar(defender);
        const combo = (acting === 1) ? gameState.player1Combo : gameState.player2Combo;
        let damage = attackerChar.attack - (defenderChar.defense * 0.3);
        damage = Math.max(damage, 10);
        // stance multiplier
        damage *= atkSt.attackMultiplier;
        // combo multiplier
        if (combo >= 3) damage *= 1.35;
        if (combo >= 5) damage *= 1.60;
        // dodge chance
        const dodged = (getPlayerStance(defender) === 'dodge') && (Math.random() < defSt.dodgeChance);
        if (dodged) damage = 0;
        else damage *= defSt.incomingMultiplier;
        damage = Math.round(damage);
        // energy gain
        if (acting === 1) gameState.player1Energy = Math.min(gameConfig.energy.maxEnergy, gameState.player1Energy + gameConfig.energy.gainOnCorrect);
        else gameState.player2Energy = Math.min(gameConfig.energy.maxEnergy, gameState.player2Energy + gameConfig.energy.gainOnCorrect);
        // apply damage
        if (defender === 1) {
          gameState.player1Health -= damage;
          if (acting === 2) gameState.player2Stats.totalDamage += damage;
        } else {
          gameState.player2Health -= damage;
          if (acting === 1) gameState.player1Stats.totalDamage += damage;
        }
        if (dodged) {
          document.getElementById('turnIndicator').textContent = `PLAYER ${defender} DODGED!`;
        } else {
          if (damage > 0) {
            showDamageEffect(defender, damage, combo >= 3);
            performAttackAnimation(acting);
          }
        }
        updateHealthBar(defender);
        updateEnergyBar(acting);
        updateComboDisplay(acting);
      } else {
        // wrong answer -> reset combo
        if (acting === 1) gameState.player1Combo = 0;
        else gameState.player2Combo = 0;
        updateComboDisplay(acting);
        // gamble self penalty
        if (getPlayerStance(acting) === 'gamble') {
          const penalty = stanceConfig.gamble.gambleSelfPenaltyOnWrong;
          if (acting === 1) {
            gameState.player1Health -= penalty;
            showDamageEffect(1, penalty, false);
            updateHealthBar(1);
          } else {
            gameState.player2Health -= penalty;
            showDamageEffect(2, penalty, false);
            updateHealthBar(2);
          }
        }
      }
      setTimeout(() => {
        if (gameState.mode === 'duo' && gameState.buzzMode) {
          nextQuestion(); // return to waiting buzz
        } else {
          gameState.currentTurn = (gameState.currentTurn === 1) ? 2 : 1;
          nextQuestion();
        }
      }, 1600);
    }
    // =========================
    // HUD updates & effects
    // =========================
    function updateHealthBar(player) {
      const health = (player === 1) ? gameState.player1Health : gameState.player2Health;
      const maxH = (player === 1) ? gameState.player1MaxHealth : gameState.player2MaxHealth;
      const pct = Math.max(0, (health / maxH) * 100);
      const hp = document.getElementById(`hudP${player}HP`);
      const ghost = document.getElementById(`hudP${player}Ghost`);
      const text = document.getElementById(`hudP${player}Text`);
      hp.style.width = `${pct}%`;
      text.textContent = `${Math.max(0, Math.round(health))}/${maxH}`;
      setTimeout(() => {
        ghost.style.width = `${pct}%`;
      }, 80);
      if (pct <= 20) hp.style.background = 'linear-gradient(90deg, #ff3366, #cc0000)';
      else if (pct <= 50) hp.style.background = 'linear-gradient(90deg, #ffcc00, #ff9900)';
      else hp.style.background = 'linear-gradient(90deg, #00ff88, #00cc66)';
    }

    function updateEnergyBar(player) {
      const energy = (player === 1) ? gameState.player1Energy : gameState.player2Energy;
      const pct = (energy / gameConfig.energy.maxEnergy) * 100;
      document.getElementById(`hudP${player}Energy`).style.width = `${pct}%`;
      document.getElementById(`hudP${player}EnergyText`).textContent = energy;
    }

    function updateComboDisplay(player) {
      const combo = (player === 1) ? gameState.player1Combo : gameState.player2Combo;
      const el = document.getElementById(`fighter${player}Combo`);
      if (combo > 0) {
        el.textContent = combo >= 5 ? `üî•üî• SUPER COMBO x${combo}` : `üî• COMBO x${combo}`;
        el.classList.add('active');
      } else {
        el.textContent = '';
        el.classList.remove('active');
      }
    }

    function performAttackAnimation(attacker) {
      const avatar = document.getElementById(`fighter${attacker}Avatar`);
      const defender = (attacker === 1) ? 2 : 1;
      const defAvatar = document.getElementById(`fighter${defender}Avatar`);
      avatar.classList.add('attacking');
      setTimeout(() => {
        avatar.classList.remove('attacking');
        defAvatar.classList.add('damaged');
        setTimeout(() => defAvatar.classList.remove('damaged'), 500);
      }, 250);
    }

    function showDamageEffect(target, damage, isCritical) {
      const fighter = document.querySelector(`.fighter.player${target}`);
      const el = document.createElement('div');
      el.className = 'damage-number';
      if (isCritical) {
        el.classList.add('critical-hit');
        el.textContent = `CRITICAL! -${damage}`;
      } else el.textContent = `-${damage}`;
      el.style.left = '50%';
      el.style.top = '20%';
      fighter.appendChild(el);
      setTimeout(() => el.remove(), 1200);
    }
    // =========================
    // Buzz mode
    // =========================
    function handleBuzzKey(e) {
      if (!(gameState.mode === 'duo' && gameState.buzzMode)) return;
      if (!document.getElementById('battleScreen').classList.contains('active')) return;
      if (gameState.buzzWinner !== null) return;
      const key = e.key.toLowerCase();
      if (key === 'a') gameState.buzzWinner = 1;
      else if (key === 'l') gameState.buzzWinner = 2;
      else return;
      lockOutBuzz();
    }

    function lockOutBuzz() {
      const p = gameState.buzzWinner;
      document.getElementById('buzzIndicator').style.display = 'none';
      document.getElementById('turnIndicator').textContent = `PLAYER ${p} BUZZED!`;
      showStancePanelFor(p);
    }
    // =========================
    // End / Reset
    // =========================
    function endGame() {
      const winner = (gameState.player1Health > 0) ? 1 : 2;
      const winnerChar = (winner === 1) ? gameState.player1 : gameState.player2;
      const winnerStats = (winner === 1) ? gameState.player1Stats : gameState.player2Stats;
      if (gameState.mode === 'solo') {
        document.getElementById('winnerTitle').textContent = (winner === 1) ? 'VICTORY!' : 'DEFEAT...';
        document.getElementById('winnerName').textContent = (winner === 1) ? winnerChar.name : `AI ${winnerChar.name} WINS`;
        document.getElementById('correctAnswers').textContent = gameState.player1Stats.correct;
        document.getElementById('totalDamage').textContent = gameState.player1Stats.totalDamage;
        document.getElementById('maxCombo').textContent = gameState.player1Stats.maxCombo;
      } else {
        document.getElementById('winnerTitle').textContent = 'VICTORY!';
        document.getElementById('winnerName').textContent = `PLAYER ${winner} - ${winnerChar.name} WINS`;
        document.getElementById('correctAnswers').textContent = winnerStats.correct;
        document.getElementById('totalDamage').textContent = winnerStats.totalDamage;
        document.getElementById('maxCombo').textContent = winnerStats.maxCombo;
      }
      const modeLabel = gameState.mode === 'solo' ? 'SOLO' : 'DUO';
      const diffLabel = gameState.mode === 'solo' ?
        (gameState.difficulty || 'normal').toUpperCase() :
        '‚Äî';
      document.getElementById('resultModeText').textContent =
        gameState.mode === 'solo' ?
        `MODE: ${modeLabel} | DIFFICULTY: ${diffLabel}` :
        `MODE: ${modeLabel}`;
      showScreen('resultScreen');
    }

    function resetGameState() {
      clearInterval(gameState.timer);
      gameState = {
        mode: null,
        difficulty: 'easy',
        buzzMode: false,
        buzzWinner: null,
        currentTurn: 1,
        selectingPlayer: 1,
        player1: null,
        player2: null,
        player1Health: 100,
        player2Health: 100,
        player1MaxHealth: 100,
        player2MaxHealth: 100,
        player1Energy: 0,
        player2Energy: 0,
        player1Combo: 0,
        player2Combo: 0,
        player1Stance: 'attack',
        player2Stance: 'attack',
        player1Stats: {
          correct: 0,
          totalDamage: 0,
          maxCombo: 0
        },
        player2Stats: {
          correct: 0,
          totalDamage: 0,
          maxCombo: 0
        },
        timer: null,
        timeLeft: 30
      };
      questionHistory = [];
      document.getElementById('startBattleBtn').disabled = true;
    }

    function resetGame() {
      resetGameState();
      showScreen('modeScreen');
      document.getElementById('difficultySelection').style.display = 'none';
      document.getElementById('duoOptions').style.display = 'none';
    }
    // boot
    init();
  </script>
</body>

</html>
